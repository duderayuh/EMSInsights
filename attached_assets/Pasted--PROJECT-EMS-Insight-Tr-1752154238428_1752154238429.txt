â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PROJECT:  EMSâ€‘Insight â€“ Transcription System Overhaul
GOAL:     Replace the current patchâ€‘work â€œwhackâ€‘aâ€‘moleâ€ fixes with a
          single, robust, productionâ€‘grade pipeline that delivers
          accurate verbatim transcripts, eliminates hallucinations from
          beeps/static, fixes address extraction, and can reâ€‘process all
          historical calls in the database.

TECH STACK (MUST MATCH EXISTING APP)
  â€¢ Backend:  Node.js 20  +  Express  +  TypeScript
  â€¢ Frontend: React  +  TypeScript  +  Tailwind CSS (shadcn/ui)
  â€¢ DB:       PostgreSQL + pgvector            (â›”  NEVER write to rdioâ€‘scanner.db)
  â€¢ Audio:    SDRTrunk â†’ Rdio Scanner SQLite (readâ€‘only) â†’ FFmpeg
  â€¢ STT:      OpenAI Whisper API   (primary)
              Local Whisper CLI    (fallback)

CORE REQUIREMENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. ğŸ“¥ **Audio Preâ€‘Processing**
   â”€ Detect pure tones/beeps via FFT or a simple energyâ€‘ratio check.
   â”€ Skip Whisper when the chunk is noiseâ€‘only; store transcript as
     `{beeping}` with low confidence instead.
   â”€ Use adaptive VAD (silencedetect or similar) to trim leading/trailing
     silence and avoid fragmenting addresses.

2. ğŸ—£ï¸ **Whisper Transcription**
   â”€ Use temperature 0, English, and include the EMS dispatch prompt below.
   â”€ For local Whisper fallback set `condition_on_previous_text=false` on
     the final segment to prevent â€œghostâ€ text bleedâ€‘over.

3. ğŸ§¹ **Postâ€‘Processing Pipeline (single module)**
   a. **Hallucination Filter**
      â€¢ Global blacklist regex for phrases like
        â€œthank you for watchingâ€, â€œsubscribeâ€, â€œwww.â€, etc.
      â€¢ If transcript is stripped to nothing â†’ mark as nonâ€‘emergency.
   b. **Address Parsing & Normalization**
      â€¢ Use a US address parser (e.g. `parse-address` or `addressit`).
      â€¢ Merge split numbers (â€œ9 0 1 5â€ â†’ â€œ9015â€).
      â€¢ Support intersections (â€œMain & 5thâ€) and highways (â€œUS 31 Sâ€).
      â€¢ Return a clean string â†’ â€œGoogle Address Validation APIâ€.
   c. **Unit / Callâ€‘Type Extraction**
      â€¢ Keep existing NLP classifier but feed it the cleaned transcript.
      â€¢ Ensure call types (87+ complaints) and unit tags stay accurate.

4. ğŸ—„ï¸ **Database & API Updates**
   â”€ Add any new flags you need (`isNoise`, `parseErrors`, etc.).
   â”€ Preserve the CRITICAL rule: never modify or delete audio in
     `rdio-scanner.db`. Only read.

5. ğŸ” **Bulk Reâ€‘Processing Tools**
   a. `scripts/reprocess_all_calls.ts`
      â€¢ Reâ€‘run address parsing, hallucination filter, NLP classification
        on every call record.
   b. `scripts/retranscribe_problem_calls.ts`
      â€¢ Reâ€‘transcribe calls that have confidence < 0.30 OR contain
        `{beeping}` OR â€œUnknown Call Typeâ€, using the new pipeline.
   â€¢ Provide an adminâ€‘only REST endpoint to trigger these scripts from
     the existing dashboard.

6. ğŸ§ª **Acceptance Tests**
   â€¢ Unit tests for hallucination filter & address parser.
   â€¢ Sample audio:
       1. Pure beep â†’ transcript EXACTLY `{beeping}`.
       2. â€œ72, 12, US 31, southâ€ â†’ cleaned address `7212 US 31 S`.
   â€¢ Endâ€‘toâ€‘end test: ingest sample dispatch, verify map pin appears with
     correct lat/lon and call type is not â€œUnknownâ€.

7. ğŸš¦ **Performance**
   â€¢ Maintain â‰¤10â€¯s endâ€‘toâ€‘end latency on live audio.
   â€¢ â‰¤1â€¯s dashboard load after your DB query optimizations.

8. ğŸ” **Deliverables**
   â€¢ Forkable Replit project with:
       - `README.md` quickâ€‘start (Docker Compose + Replit run button).
       - All code + tests + migration scripts.
       - Updated `.env.example` for new vars (still uses existing keys).
   â€¢ Short CHANGELOG summarising what you replaced vs. legacy code.
   â€¢ Demo GIF or Loom link optional but welcome.

PROMPT TO PASS TO WHISPER (EXACT STRING)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
You are an expert at interpreting Indianapolisâ€‘Marion County EMS and hospital radio traffic.  
1 Identify EMS unit IDs, fire unit IDs, exact incident addresses or intersections.  
2 Identify the callâ€‘type (e.g. Assault, MVC, Cardiac Arrest, Trash Fire, Sick Person).  
3 Use 24â€‘hour time if present.  
4 If audio contains ONLY electronic tones, beeps, or static, output exactly `{beeping}` and nothing else.  
5 Never invent text that was not spoken.  
6 For unclear audio use `[inaudible]`.  
Return verbatim speech otherwise.